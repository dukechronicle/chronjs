<!DOCTYPE HTML>
<html> 
    <head> 
        <meta charset="utf-8"> 
        <meta name="viewport" content="width=device-width, minimum-scale=1, maximum-scale=1"> 
        <link rel="stylesheet" href="/m/themes/chronicle.min.css" />
        <link rel="stylesheet" href="http://code.jquery.com/mobile/1.0.1/jquery.mobile.structure-1.0.1.min.css" />

        <!--<script src="http://use.typekit.com/dwv2bjy.js"></script>
        <script>
            try{Typekit.load();}catch(e){}
        </script>
		-->

        <script src="http://code.jquery.com/jquery-1.6.2.min.js"></script>
        <script src="http://code.jquery.com/mobile/1.0.1/jquery.mobile-1.0.1.min.js"></script>
    
        <script type="text/javascript"> 
            $(document).bind("mobileinit", function() {
                $.mobile.page.prototype.options.addBackBtn = true;
                $.mobile.page.prototype.options.backBtnText = "Prev";
                $.mobile.page.prototype.options.backBtnTheme = "a";
                //$.mobile.touchOverflowEnabled = true;
            });        
        </script> 
        
        <script type="text/javascript"> 
            // onLoad parse URL
            $(function() {
                // m/asdlfjsladkd
                var relativeURL = window.location.pathname;

                // " ", "m", "article", articleName
                var splitString = relativeURL.split("/");

                // TODO: malformed input?
                if(splitString[2] == "article" && splitString[3] != null && splitString[3] != "")
                {
                    getArticle(splitString[3]);
                }
                else
                {
                    getArticleList('all', 'The Chronicle', true);
                }
            });        
        </script> 

		<link rel="stylesheet" href="/m/css/chronmobile.css" />
        
		<script type="text/javascript"> 
		var ARTICLE_LIST = "#ARTICLE_LIST";
		var ARTICLE_CONTENT = "#ARTICLE_CONTENT";
		var HEADER_TITLE = "#HEADER_TITLE";
        var UNKNOWN_ERROR = "An unknown error has occured, click back to return to the previous page.";
        var ARTICLE_NOT_FOUND = "The article cannot be found. Hit back to return to the previous page.";

        // Cache the list of articles. Emphemeral.
        var articleListCache = [];
        
        // Cache life = 100 seconds
        var ARTICLE_LIST_CACHE_TIMEOUT = 100000;

        // Cache the articles. Shouldn't be cleared.
        var articleCache = [];
       
		function generateListItem(articleJSON)
		{
			var article = articleJSON;
                
			// Containers
			var listItem = $('<li />');
			
			// Hyperlink
			article.url = article.urls[article.urls.length - 1];
			var hyperlink = $('<a />',{ "href":"javascript:getArticle('" + article.url+ "')"});
			
			// Thumbnail
			// hyperlink.append('<img src="' + 'img/test.png"' + ' "class"="ui-li-thumb" />');
			
			// Article Title
			hyperlink.append($('<h3 />').text(article.title));
			
			// Article Synopsis
			hyperlink.append($('<p />').text(article.teaser));
		
			return listItem.append(hyperlink);
		}

        function updateArticleList(responseText, articleListContainer, category)
        {
            var articleListResponse = responseText;
			$(HEADER_TITLE).text(category);

            if(articleListResponse == null)
            {
                $.mobile.changePage('#error', 'slide');
                return;
            }
        
			$(ARTICLE_LIST).empty();

            for(var i in articleListResponse)
            {
                $(ARTICLE_LIST).append(generateListItem(articleListResponse[i]));
            }
	
			$(ARTICLE_LIST).listview('refresh');
        }
    
        function getArticleList(category, title, forced)
        {
            // Retrieve if cache miss, forced reload, or if cache is too old:
            if(articleListCache[category] == null || forced || new Date().getTime() - articleListCache[category].timestamp > ARTICLE_LIST_CACHE_TIMEOUT)
            {
                //console.log("article list : cachemiss");
                var url = "/api/" + category;
                //console.log(url);
                $.ajax({
                    url: url,
                    cache: false,
                    dataType: "jsonp",
                    success: function(data){
                        //console.log(category);
                        if(!data) {
                            $.mobile.changePage('#error', 'none');
                            return;
                        }
                        // Insert into cache
                        articleListCache[category] = {timestamp: new Date().getTime(), data: data};
                        updateArticleList(articleListCache[category].data, $(this), title);
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        handleAJAXError(jqXHR);
                    } 

                });
            } 
			else {
                updateArticleList(articleListCache[category].data, $(this), title);
            }
        }

		function generateArticle(articleJSON)
        {
            var article = articleJSON;
            
            if(article == null)
            {
                $.mobile.changePage('#error', 'slide');
                return;
            }
            
			var totalString = $('<div />');
			totalString.append($('<h2 />').append(article.title));

            for(author in article.authors)
            {
                var authorString = $('<p />', {"class": "author"}).append(article.authors[author]);
				totalString.append(authorString);
            }
            
            //console.log(article);
            totalString.append($('<p />').append(article.renderedBody));
           
			return totalString;
        }
        
        function handleAJAXError(jqXHR)
        {
            if(jqXHR.status == 500)
            {
                $(ERROR_MESSAGE).text(ARTICLE_NOT_FOUND);
            }
            else
            {
                $(ERROR_MESSAGE).text(UNKNOWN_ERROR);
            }
            $.mobile.changePage('#error', 'slide');
        }

        function getArticle(articleURL)
        {
            // Retrieve if cache miss, forced reload, or if cache is too old:
            if(articleCache[articleURL] == null)
            {
                //console.log("article cache: cachemiss");
                $.ajax({
                    url: "/api/article/url/" + articleURL,
                    dataType: "jsonp",
                    cache: false,
                    success: function(data){
                        if(!data) {
                            //console.log("get article failed");
                            $.mobile.changePage('#error', 'slide');
                            return;
                        }
     
                        // Insert into cache
                        articleCache[articleURL] = {data: data};
     
                        $(ARTICLE_CONTENT).html(generateArticle(articleCache[articleURL].data));
	     				$.mobile.changePage("#Article","slide");
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        handleAJAXError(jqXHR);
                    }  
                });
            }
			else {
                $(ARTICLE_CONTENT).html(generateArticle(articleCache[articleURL].data));
   				$.mobile.changePage("#Article","slide");
            } 
        }
             

        function getSectionList()
        {
			$(ARTICLE_LIST).empty();
			$(HEADER_TITLE).text("The Chronicle");

            // Containers
            var categories = ["News", "Sports", "Opinion", "Recess", "Towerview"];
            for(var i in categories)
            {
			    var listItem = $('<li />');
			    hyperlink = $('<a />',{ "href":"javascript:getArticleList('" + categories[i] + "','" + categories[i] +"')"});
                hyperlink.append($('<h4 />').text(categories[i]));
                listItem.append(hyperlink);
                $(ARTICLE_LIST).append(listItem);
            }   
        
			$(ARTICLE_LIST).listview('refresh');
        }

    
        </script>

		<!-- Google Analytics Code-->
        <script>
			var _gaq = _gaq || [];
			_gaq.push(['_setAccount', 'UA-5900287-12']);

			(function() {
			  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
			})();

			$('[data-role=page]').live('pageshow', function (event, ui) {
				try {

					hash = location.hash;

					if (hash && hash.length > 1) {
						_gaq.push(['_trackPageview', hash.substr(1)]);
					} else {
						_gaq.push(['_trackPageview']);
					}
				} catch(err) {

				}

			});
		</script>
    </head>
    
    <body>
        <div id="ArticleList" data-role="page" articleListContainer="true" url="news" data-add-back-btn="false"> 
            <div data-role="header" data-position="fixed"> 
                <h1 id="HEADER_TITLE" >The Chronicle</h1>
            </div> 
                <div id="ArticleListContent" data-role="content">    
					<ul id="ARTICLE_LIST" data-role="listview">
					</ul>
                </div> 
            <div data-role="footer" data-position="fixed"> 
                <div data-role="navbar"> 
                    <ul> 
                        <li><a href="javascript:getArticleList('All', 'The Chronicle', false)">All Stories</a></li> 
                        <li><a href="javascript:getSectionList()">Sections</a></li> 
                    </ul> 
                </div>
            </div> 
        </div> 


	<div id="Article" data-role="page" articleContainer="true" url="Article" data-add-back-btn="true" data-back-btn-text="Back"> 
		<div data-role="header"> 
			<h1>The Chronicle</h1>
		</div> 
		<div id="ARTICLE_CONTENT" data-role="content" data-position="fixed"></div> 
		<div data-role="footer" data-position="fixed"></div> 
	</div> 

	<div id="error" data-role="page" articleContainer="true" url="Article" data-add-back-btn="true" data-back-btn-text="Back"> 
		<div data-role="header"> 
			<h1>Error</h1> 
		</div> 
		<div id="ERROR_MESSAGE" data-role="content">    
			An error has occured, click back to return to the previous page.
		</div> 
	</div> 

    </body> 
</html> 
